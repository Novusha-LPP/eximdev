# Multi-Branch Architecture Guide

This document explains the implementation of multi-branch support in the AlVision Exim application, specifically how it handles branch-specific data collections for the `Job` model.

## Overview

The application now supports multiple branches (e.g., **AHMEDABAD HO**, **GANDHIDHAM**, **AIR**) using a shared database but separate collections for job-related data. This ensures that each branch can maintain its own sequence of jobs and manage its data independently while leveraging a common schema.

### Branch Identification

The current branch is identified by the `x-branch` header sent from the client.
- `AIR` -> `jobs_air` collection
- `GANDHIDHAM` -> `jobs_gandhidham` collection
- `AHMEDABAD HO` (and others) -> `jobs` collection

## Backend Implementation

### 1. `branchJobMiddleware.mjs`

This middleware intercepts every request, detects the branch from the header, and attaches the appropriate Mongoose model to the request object as `req.JobModel`.

```javascript
import { getJobModelForBranch } from "../utils/modelHelper.mjs";

const branchJobMiddleware = (req, res, next) => {
    const branch = req.headers['x-branch'] || 'AHMEDABAD HO';
    req.JobModel = getJobModelForBranch(branch);
    next();
};
```

### 2. `modelHelper.mjs`

A utility that manages the creation and caching of branch-specific models. It maps a branch name to a specific collection name.

### 3. Route Refactoring

All routes that interact with the `Job` model have been refactored to remove direct imports of `JobModel`. Instead, they extract the model from the request:

```javascript
router.get('/api/jobs', async (req, res) => {
    const JobModel = req.JobModel; // Dynamically provided correct collection
    const jobs = await JobModel.find({});
    // ...
});
```

## Key Considerations

### WebSockets

For WebSocket connections, where there is no per-request header, the branch must be passed in the initial message payload or determined at connection time. `setupJobOverviewWebSocket.mjs` has been updated to handle this.

### Audit Trails

The `auditMiddleware` has been enhanced to be branch-aware. If it detects `req.JobModel`, it will use that for recording changes, ensuring audit trails are stored against the correct branch data.

### Job Number Generation

Job numbers are generated by querying the last job in the *current* collection. Since each branch has its own collection, this naturally results in branch-specific job number sequences.

## Adding a New Branch

To add a new branch:
1. Update `client/src/contexts/BranchContext.js` to include the new branch option.
2. Update `server/utils/modelHelper.mjs` to define a new collection name for the branch.
3. Ensure the client sends the correct `x-branch` header for all API calls.
